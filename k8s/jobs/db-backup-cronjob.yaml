apiVersion: batch/v1
kind: CronJob
metadata:
  name: db-backup
  namespace: hospital-erp-system
  labels:
    app: hospital-erp
    component: database
    job-type: backup
spec:
  schedule: '0 2 * * *'
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app: hospital-erp
        component: database
        job-type: backup
    spec:
      template:
        metadata:
          labels:
            app: hospital-erp
            component: database
            job-type: backup
        spec:
          serviceAccountName: backend-sa
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: postgres:16-alpine
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  BACKUP_FILE="/backup/hospital-erp-$(date +%Y%m%d-%H%M%S).sql"
                  pg_dump -Fc -f "$BACKUP_FILE" "$DATABASE_URL"
                  echo "Backup completed: $BACKUP_FILE"
              env:
                - name: PGHOST
                  valueFrom:
                    configMapKeyRef:
                      name: backend-config
                      key: DATABASE_HOST
                - name: PGPORT
                  valueFrom:
                    configMapKeyRef:
                      name: backend-config
                      key: DATABASE_PORT
                - name: PGDATABASE
                  valueFrom:
                    configMapKeyRef:
                      name: backend-config
                      key: DATABASE_NAME
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: backend-secrets
                      key: DATABASE_USER
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: backend-secrets
                      key: DATABASE_PASSWORD
              volumeMounts:
                - name: backup-volume
                  mountPath: /backup
              resources:
                requests:
                  memory: '256Mi'
                  cpu: '100m'
                limits:
                  memory: '512Mi'
                  cpu: '500m'
          volumes:
            - name: backup-volume
              persistentVolumeClaim:
                claimName: db-backup-pvc
