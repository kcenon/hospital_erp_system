# 시스템 아키텍처 설계서

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서 버전 | 0.1.0.0 |
| 작성일 | 2025-12-29 |
| 상태 | 초안 |
| 관리자 | kcenon@naver.com |

---

## 1. 아키텍처 개요

### 1.1 시스템 컨텍스트 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              외부 시스템                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│   │  기존 진료    │    │   SMS/알림   │    │   백업 저장소 │                  │
│   │  프로그램     │    │   서비스     │    │   (S3)       │                  │
│   └──────┬───────┘    └──────┬───────┘    └──────┬───────┘                  │
│          │                   │                   │                          │
└──────────┼───────────────────┼───────────────────┼──────────────────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                    ┌─────────────────────────────┐                          │
│                    │    입원환자 관리 ERP 시스템   │                          │
│                    │                             │                          │
│                    │  ┌─────────────────────┐   │                          │
│                    │  │     API Gateway     │   │                          │
│                    │  └─────────────────────┘   │                          │
│                    │            │               │                          │
│                    │  ┌─────────┴─────────┐    │                          │
│                    │  │   Application     │    │                          │
│                    │  │   Services        │    │                          │
│                    │  └─────────┬─────────┘    │                          │
│                    │            │               │                          │
│                    │  ┌─────────┴─────────┐    │                          │
│                    │  │    Data Layer     │    │                          │
│                    │  └───────────────────┘    │                          │
│                    │                             │                          │
│                    └─────────────────────────────┘                          │
│                                 ▲                                           │
└─────────────────────────────────┼───────────────────────────────────────────┘
                                  │
           ┌──────────────────────┼──────────────────────┐
           │                      │                      │
    ┌──────┴──────┐       ┌──────┴──────┐       ┌──────┴──────┐
    │   PC Web    │       │   Tablet    │       │   Mobile    │
    │  (원무/관리) │       │   (회진)    │       │  (간호사)   │
    └─────────────┘       └─────────────┘       └─────────────┘
```

### 1.2 아키텍처 원칙

| 원칙 | 설명 | 적용 |
|------|------|------|
| **계층 분리** | Presentation, Business, Data 분리 | 유지보수성 향상 |
| **모듈화** | 도메인별 독립 모듈 | 확장성, 테스트 용이 |
| **느슨한 결합** | 인터페이스 기반 의존성 | 변경 영향 최소화 |
| **보안 우선** | 모든 계층에 보안 적용 | 의료 데이터 보호 |
| **확장성** | 수평 확장 가능 설계 | 사용량 증가 대응 |

---

## 2. 논리적 아키텍처

### 2.1 계층 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  PC Web     │  │  Tablet Web │  │  Mobile Web             │  │
│  │  (Next.js)  │  │  (Next.js)  │  │  (Next.js PWA)          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                    API GATEWAY LAYER                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  • Authentication & Authorization                           ││
│  │  • Rate Limiting                                            ││
│  │  • Request/Response Logging                                 ││
│  │  • API Versioning                                           ││
│  └─────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│                    APPLICATION LAYER                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │
│  │   Auth    │ │  Patient  │ │   Room    │ │  Report   │       │
│  │  Module   │ │  Module   │ │  Module   │ │  Module   │       │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │
│  │ Admission │ │ Rounding  │ │Integration│ │   Admin   │       │
│  │  Module   │ │  Module   │ │  Module   │ │  Module   │       │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │
├─────────────────────────────────────────────────────────────────┤
│                    DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  • Entities (Patient, Room, Bed, Report, User)              ││
│  │  • Value Objects (VitalSigns, BloodPressure, Dosage)        ││
│  │  • Domain Services (AdmissionService, TransferService)      ││
│  │  • Domain Events (PatientAdmitted, RoomTransferred)         ││
│  └─────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│                    INFRASTRUCTURE LAYER                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │
│  │PostgreSQL │ │   Redis   │ │  Legacy   │ │    S3     │       │
│  │Repository │ │   Cache   │ │  Adapter  │ │  Storage  │       │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 모듈 상세 설명

| 모듈 | 책임 | 주요 기능 |
|------|------|----------|
| **Auth Module** | 인증/인가 | 로그인, 세션 관리, 권한 검증 |
| **Patient Module** | 환자 관리 | 환자 CRUD, 검색, 이력 조회 |
| **Room Module** | 병실 관리 | 병실 현황, 배치도, 빈 병상 |
| **Admission Module** | 입퇴원 관리 | 입원, 전실, 퇴원 처리 |
| **Report Module** | 보고서/일지 | 간호일지, 치료보고서, 바이탈 |
| **Rounding Module** | 라운딩 관리 | 회진 기록, 모바일 입력 |
| **Integration Module** | 외부 연동 | 기존 시스템 동기화 |
| **Admin Module** | 관리 기능 | 사용자, 권한, 설정, 로그 |

---

## 3. 물리적 아키텍처

### 3.1 배포 다이어그램 (AWS)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                  AWS Cloud                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           VPC (10.0.0.0/16)                          │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  ┌─────────────── Public Subnet (10.0.1.0/24) ──────────────────┐   │   │
│  │  │                                                               │   │   │
│  │  │   ┌──────────────┐         ┌──────────────┐                  │   │   │
│  │  │   │     ALB      │         │   NAT GW     │                  │   │   │
│  │  │   │ (HTTPS:443)  │         │              │                  │   │   │
│  │  │   └──────┬───────┘         └──────────────┘                  │   │   │
│  │  │          │                                                    │   │   │
│  │  └──────────┼────────────────────────────────────────────────────┘   │   │
│  │             │                                                         │   │
│  │  ┌──────────┼─────── Private Subnet (10.0.2.0/24) ──────────────┐   │   │
│  │  │          │                                                    │   │   │
│  │  │          ▼                                                    │   │   │
│  │  │   ┌──────────────────────────────────────────┐               │   │   │
│  │  │   │            ECS Cluster (Fargate)          │               │   │   │
│  │  │   │  ┌────────────────┐ ┌────────────────┐   │               │   │   │
│  │  │   │  │  App Service   │ │ Worker Service │   │               │   │   │
│  │  │   │  │  (2 Tasks)     │ │ (1 Task)       │   │               │   │   │
│  │  │   │  └────────────────┘ └────────────────┘   │               │   │   │
│  │  │   └──────────────────────────────────────────┘               │   │   │
│  │  │                                                               │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  │  ┌─────────────── Data Subnet (10.0.3.0/24) ────────────────────┐   │   │
│  │  │                                                               │   │   │
│  │  │   ┌────────────────┐         ┌────────────────┐              │   │   │
│  │  │   │  RDS Primary   │ ──────> │  RDS Standby   │              │   │   │
│  │  │   │  PostgreSQL    │         │  (Multi-AZ)    │              │   │   │
│  │  │   └────────────────┘         └────────────────┘              │   │   │
│  │  │                                                               │   │   │
│  │  │   ┌────────────────┐                                         │   │   │
│  │  │   │  ElastiCache   │                                         │   │   │
│  │  │   │  (Redis)       │                                         │   │   │
│  │  │   └────────────────┘                                         │   │   │
│  │  │                                                               │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   CloudFront    │  │       S3        │  │   CloudWatch    │             │
│  │   (CDN)         │  │   (Storage)     │  │   (Monitoring)  │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 컨테이너 구성

```yaml
# docker-compose.yml (개발 환경)
version: '3.8'

services:
  app:
    build: ./apps/backend
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/hospital_erp
      - REDIS_URL=redis://cache:6379
    depends_on:
      - db
      - cache

  frontend:
    build: ./apps/frontend
    ports:
      - "8080:8080"
    environment:
      - API_URL=http://app:3000

  db:
    image: postgres:16
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=hospital_erp
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass

  cache:
    image: redis:7-alpine
    volumes:
      - redisdata:/data

volumes:
  pgdata:
  redisdata:
```

---

## 4. 데이터 흐름 아키텍처

### 4.1 입원 수속 프로세스

```
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│   원무과    │    │  Frontend  │    │  Backend   │    │  Database  │
│   담당자    │    │  (Next.js) │    │  (NestJS)  │    │(PostgreSQL)│
└─────┬──────┘    └─────┬──────┘    └─────┬──────┘    └─────┬──────┘
      │                 │                 │                 │
      │  1. 입원 등록   │                 │                 │
      │────────────────>│                 │                 │
      │                 │                 │                 │
      │                 │  2. POST /api   │                 │
      │                 │    /admissions  │                 │
      │                 │────────────────>│                 │
      │                 │                 │                 │
      │                 │                 │  3. 기존 시스템  │
      │                 │                 │     환자 조회    │
      │                 │                 │ ──────────────> │
      │                 │                 │ <────────────── │
      │                 │                 │                 │
      │                 │                 │  4. 입원 정보   │
      │                 │                 │     저장        │
      │                 │                 │────────────────>│
      │                 │                 │                 │
      │                 │                 │  5. 병실 상태   │
      │                 │                 │     업데이트    │
      │                 │                 │────────────────>│
      │                 │                 │                 │
      │                 │  6. 성공 응답   │                 │
      │                 │<────────────────│                 │
      │                 │                 │                 │
      │                 │  7. 실시간     │                 │
      │                 │     현황판     │                 │
      │                 │     업데이트   │                 │
      │                 │    (WebSocket) │                 │
      │  8. 확인       │                 │                 │
      │<────────────────│                 │                 │
      │                 │                 │                 │
```

### 4.2 라운딩 보고 프로세스 (모바일)

```
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│    의사    │    │   Tablet   │    │  Backend   │    │   Redis    │
│            │    │  (PWA)     │    │  (NestJS)  │    │  (Cache)   │
└─────┬──────┘    └─────┬──────┘    └─────┬──────┘    └─────┬──────┘
      │                 │                 │                 │
      │  1. 환자 선택   │                 │                 │
      │────────────────>│                 │                 │
      │                 │                 │                 │
      │                 │  2. GET /api    │                 │
      │                 │    /patients/:id│                 │
      │                 │────────────────>│                 │
      │                 │                 │  3. 캐시 조회   │
      │                 │                 │────────────────>│
      │                 │                 │<────────────────│
      │                 │                 │                 │
      │                 │  4. 환자 정보   │                 │
      │                 │<────────────────│                 │
      │                 │                 │                 │
      │  5. 바이탈 입력 │                 │                 │
      │────────────────>│                 │                 │
      │                 │                 │                 │
      │                 │  6. POST /api   │                 │
      │                 │    /vitals      │                 │
      │                 │────────────────>│                 │
      │                 │                 │                 │
      │                 │  7. 저장 완료   │                 │
      │                 │<────────────────│                 │
      │                 │                 │                 │
      │  8. 다음 환자   │                 │                 │
      │────────────────>│                 │                 │
```

---

## 5. 보안 아키텍처

### 5.1 인증/인가 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                       Security Architecture                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    1. Authentication                      │  │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────────────┐   │  │
│  │  │  Login   │───>│  Verify  │───>│  Issue JWT       │   │  │
│  │  │  Request │    │  Creds   │    │  (Access+Refresh)│   │  │
│  │  └──────────┘    └──────────┘    └──────────────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    2. Authorization                       │  │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────────────┐   │  │
│  │  │  API     │───>│  RBAC    │───>│  Resource        │   │  │
│  │  │  Request │    │  Check   │    │  Access Control  │   │  │
│  │  └──────────┘    └──────────┘    └──────────────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    3. Audit Logging                       │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │  WHO(User) + WHEN(Time) + WHAT(Action) + WHERE   │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 역할 기반 접근 제어 (RBAC)

```typescript
// 역할 및 권한 정의
enum Role {
  ADMIN = 'ADMIN',           // 시스템 관리자
  DOCTOR = 'DOCTOR',         // 의사
  HEAD_NURSE = 'HEAD_NURSE', // 수간호사
  NURSE = 'NURSE',           // 간호사
  CLERK = 'CLERK',           // 원무과
}

// 권한 매핑
const permissions = {
  [Role.ADMIN]: ['*'],  // 전체 권한
  [Role.DOCTOR]: [
    'patient:read', 'patient:update',
    'report:read', 'report:write',
    'rounding:*',
  ],
  [Role.HEAD_NURSE]: [
    'patient:read', 'patient:update',
    'room:read', 'room:update',
    'report:*',
  ],
  [Role.NURSE]: [
    'patient:read',
    'vital:write',
    'report:read', 'report:write:own',
  ],
  [Role.CLERK]: [
    'patient:read', 'patient:create',
    'admission:*',
    'room:read',
  ],
};
```

---

## 6. 통합 아키텍처

### 6.1 기존 시스템 연동

```
┌─────────────────────────────────────────────────────────────────┐
│                    Integration Architecture                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────┐         ┌────────────────────────────────┐ │
│  │  기존 진료      │         │         신규 ERP 시스템         │ │
│  │  프로그램       │         │                                │ │
│  │                │         │  ┌────────────────────────┐   │ │
│  │  ┌──────────┐  │         │  │   Integration Module   │   │ │
│  │  │  Legacy  │  │ ──────> │  │                        │   │ │
│  │  │  DB      │  │  JDBC/  │  │  ┌──────────────────┐ │   │ │
│  │  │          │  │  API    │  │  │  Legacy Adapter  │ │   │ │
│  │  └──────────┘  │         │  │  └──────────────────┘ │   │ │
│  │                │         │  │                        │   │ │
│  └────────────────┘         │  │  ┌──────────────────┐ │   │ │
│                             │  │  │  Data Mapper     │ │   │ │
│                             │  │  └──────────────────┘ │   │ │
│                             │  │                        │   │ │
│                             │  │  ┌──────────────────┐ │   │ │
│                             │  │  │  Sync Scheduler  │ │   │ │
│                             │  │  └──────────────────┘ │   │ │
│                             │  │                        │   │ │
│                             │  └────────────────────────┘   │ │
│                             │                                │ │
│                             │  ┌────────────────────────┐   │ │
│                             │  │      ERP Database      │   │ │
│                             │  └────────────────────────┘   │ │
│                             │                                │ │
│                             └────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 동기화 전략

| 데이터 유형 | 동기화 방식 | 주기 | 비고 |
|------------|------------|------|------|
| 환자 기본정보 | Pull (조회 시) | 실시간 | 캐시 5분 |
| 진료 내역 | Pull (조회 시) | 실시간 | 읽기 전용 |
| 입원 상태 | Bidirectional | 이벤트 기반 | 트랜잭션 처리 |
| 처방 정보 | Pull | 5분 배치 | 읽기 전용 |

---

## 7. 확장성 및 가용성

### 7.1 수평 확장 전략

```
                     ┌─────────────────┐
                     │  Load Balancer  │
                     │     (ALB)       │
                     └────────┬────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   App #1     │     │   App #2     │     │   App #3     │
│  (Container) │     │  (Container) │     │  (Container) │
└──────────────┘     └──────────────┘     └──────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                    ▼                   ▼
            ┌──────────────┐   ┌──────────────┐
            │   Primary    │   │   Replica    │
            │   (RDS)      │   │   (Read)     │
            └──────────────┘   └──────────────┘
```

### 7.2 가용성 설계

| 구성요소 | 가용성 전략 | 목표 RTO | 목표 RPO |
|----------|------------|----------|----------|
| Application | Multi-AZ 배포 | 1분 | 0 |
| Database | RDS Multi-AZ | 5분 | 1분 |
| Cache | Redis Cluster | 1분 | 5분 |
| Storage | S3 Cross-Region | 1시간 | 0 |

---

## 8. 모니터링 및 운영

### 8.1 관측성 스택

```
┌─────────────────────────────────────────────────────────────────┐
│                    Observability Stack                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │    Metrics     │  │     Logs       │  │    Traces      │    │
│  │  (CloudWatch)  │  │  (CloudWatch   │  │   (X-Ray)      │    │
│  │                │  │   Logs)        │  │                │    │
│  └───────┬────────┘  └───────┬────────┘  └───────┬────────┘    │
│          │                   │                   │              │
│          └───────────────────┼───────────────────┘              │
│                              │                                   │
│                              ▼                                   │
│                    ┌────────────────┐                           │
│                    │   Dashboard    │                           │
│                    │  (CloudWatch)  │                           │
│                    └───────┬────────┘                           │
│                            │                                     │
│                            ▼                                     │
│                    ┌────────────────┐                           │
│                    │    Alerts      │                           │
│                    │    (SNS)       │                           │
│                    └────────────────┘                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 핵심 메트릭

| 메트릭 | 임계값 | 알림 |
|--------|--------|------|
| API 응답 시간 (P95) | > 1초 | Warning |
| API 에러율 | > 1% | Critical |
| CPU 사용률 | > 80% | Warning |
| 메모리 사용률 | > 85% | Warning |
| DB 연결 풀 | > 80% | Warning |
| 동시 사용자 | > 100 | Info |

---

## 부록: 기술 의사결정 기록 (ADR)

### ADR-001: 모놀리식 vs 마이크로서비스

**상태**: 승인됨

**결정**: 모듈러 모놀리식 아키텍처 채택

**근거**:
1. 초기 규모 (100명 이하 동시 사용자)에 마이크로서비스는 과도함
2. 개발/운영 복잡도 최소화
3. 향후 필요시 모듈 단위 분리 가능

### ADR-002: 데이터베이스 선택

**상태**: 승인됨

**결정**: PostgreSQL 16 채택

**근거**:
1. 의료 데이터의 ACID 보장 필수
2. JSONB로 유연한 스키마 확장
3. Row-Level Security로 환자별 접근 제어
4. 성숙한 생태계와 도구 지원
