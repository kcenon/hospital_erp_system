// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "patient", "room", "admission", "report", "rounding", "audit"]
}

// =============================================================================
// Room Management Schema (room schema)
// Related Requirements: REQ-FR-010~015
// =============================================================================

/// Building entity for hospital infrastructure
model Building {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique @db.VarChar(20)
  name      String   @db.VarChar(100)
  address   String?  @db.Text
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  floors Floor[]

  @@map("buildings")
  @@schema("room")
}

/// Floor entity within buildings
model Floor {
  id          String   @id @default(uuid()) @db.Uuid
  buildingId  String   @map("building_id") @db.Uuid
  floorNumber Int      @map("floor_number")
  name        String   @db.VarChar(100)
  department  String?  @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms    Room[]

  @@unique([buildingId, floorNumber])
  @@index([buildingId])
  @@map("floors")
  @@schema("room")
}

/// Room type enumeration
enum RoomType {
  WARD
  ICU
  ISOLATION
  VIP
  EMERGENCY

  @@schema("room")
}

/// Room entity for patient accommodation
model Room {
  id         String   @id @default(uuid()) @db.Uuid
  floorId    String   @map("floor_id") @db.Uuid
  roomNumber String   @map("room_number") @db.VarChar(20)
  name       String?  @db.VarChar(100)
  roomType   RoomType @map("room_type")
  bedCount   Int      @default(1) @map("bed_count")
  isActive   Boolean  @default(true) @map("is_active")
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  floor Floor @relation(fields: [floorId], references: [id], onDelete: Cascade)
  beds  Bed[]

  @@unique([floorId, roomNumber])
  @@index([floorId])
  @@map("rooms")
  @@schema("room")
}

/// Bed status enumeration
enum BedStatus {
  EMPTY
  OCCUPIED
  RESERVED
  MAINTENANCE

  @@schema("room")
}

/// Bed entity for individual patient beds
model Bed {
  id                 String    @id @default(uuid()) @db.Uuid
  roomId             String    @map("room_id") @db.Uuid
  bedNumber          String    @map("bed_number") @db.VarChar(10)
  status             BedStatus @default(EMPTY)
  currentAdmissionId String?   @map("current_admission_id") @db.Uuid
  notes              String?   @db.Text
  isActive           Boolean   @default(true) @map("is_active")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, bedNumber])
  @@index([roomId])
  @@index([status])
  @@map("beds")
  @@schema("room")
}

// =============================================================================
// Patient Management Schema (patient schema)
// Related Requirements: REQ-FR-001~004
// =============================================================================

/// Gender enumeration
enum Gender {
  MALE
  FEMALE
  OTHER

  @@schema("patient")
}

/// Patient entity for patient management
model Patient {
  id                       String    @id @default(uuid()) @db.Uuid
  patientNumber            String    @unique @map("patient_number") @db.VarChar(20)
  name                     String    @db.VarChar(100)
  birthDate                DateTime  @map("birth_date") @db.Date
  gender                   Gender
  bloodType                String?   @map("blood_type") @db.VarChar(10)
  phone                    String?   @db.VarChar(20)
  address                  String?   @db.Text
  emergencyContactName     String?   @map("emergency_contact_name") @db.VarChar(100)
  emergencyContactPhone    String?   @map("emergency_contact_phone") @db.VarChar(20)
  emergencyContactRelation String?   @map("emergency_contact_relation") @db.VarChar(50)
  legacyPatientId          String?   @map("legacy_patient_id") @db.VarChar(50)
  createdAt                DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt                DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  detail PatientDetail?

  @@index([patientNumber])
  @@index([name])
  @@index([legacyPatientId])
  @@index([deletedAt])
  @@map("patients")
  @@schema("patient")
}

/// PatientDetail entity for sensitive patient information
model PatientDetail {
  id                       String   @id @default(uuid()) @db.Uuid
  patientId                String   @unique @map("patient_id") @db.Uuid
  ssnEncrypted             Bytes?   @map("ssn_encrypted")
  medicalHistoryEncrypted  Bytes?   @map("medical_history_encrypted")
  allergies                String?  @db.Text
  insuranceType            String?  @map("insurance_type") @db.VarChar(50)
  insuranceNumberEncrypted Bytes?   @map("insurance_number_encrypted")
  insuranceCompany         String?  @map("insurance_company") @db.VarChar(100)
  notes                    String?  @db.Text
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_details")
  @@schema("patient")
}

/// Sequence for patient number generation
model PatientSequence {
  id        Int      @id @default(autoincrement())
  year      Int      @unique
  lastValue Int      @default(0) @map("last_value")
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@map("patient_sequences")
  @@schema("patient")
}
