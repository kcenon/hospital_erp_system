// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "patient", "room", "admission", "report", "rounding", "audit"]
}

// =============================================================================
// Authentication Schema (public schema)
// Related Requirements: REQ-FR-060~064, REQ-NFR-023
// =============================================================================

/// User entity for authentication and authorization
model User {
  id                String    @id @default(uuid()) @db.Uuid
  employeeId        String    @unique @map("employee_id") @db.VarChar(20)
  username          String    @unique @db.VarChar(50)
  passwordHash      String    @map("password_hash") @db.VarChar(255)
  name              String    @db.VarChar(100)
  email             String?   @db.VarChar(255)
  phone             String?   @db.VarChar(20)
  department        String?   @db.VarChar(100)
  position          String?   @db.VarChar(100)
  isActive          Boolean   @default(true) @map("is_active")
  lastLoginAt       DateTime? @map("last_login_at") @db.Timestamptz
  passwordChangedAt DateTime? @map("password_changed_at") @db.Timestamptz
  failedLoginCount  Int       @default(0) @map("failed_login_count")
  lockedUntil       DateTime? @map("locked_until") @db.Timestamptz
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  userRoles     UserRole[] @relation("UserRoles")
  assignedRoles UserRole[] @relation("AssignedBy")

  @@index([username])
  @@index([employeeId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("users")
  @@schema("public")
}

/// Role entity for role-based access control
model Role {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(50)
  name        String   @db.VarChar(100)
  description String?  @db.Text
  level       Int
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@index([code])
  @@index([isActive])
  @@map("roles")
  @@schema("public")
}

/// Permission entity for fine-grained access control
model Permission {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(100)
  resource    String   @db.VarChar(50)
  action      String   @db.VarChar(50)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  rolePermissions RolePermission[]

  @@index([resource])
  @@index([code])
  @@map("permissions")
  @@schema("public")
}

/// UserRole junction table for user-role assignment
model UserRole {
  userId     String   @map("user_id") @db.Uuid
  roleId     String   @map("role_id") @db.Uuid
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamptz
  assignedBy String?  @map("assigned_by") @db.Uuid

  // Relations
  user     User  @relation("UserRoles", fields: [userId], references: [id], onDelete: Cascade)
  role     Role  @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assigner User? @relation("AssignedBy", fields: [assignedBy], references: [id], onDelete: SetNull)

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
  @@schema("public")
}

/// RolePermission junction table for role-permission assignment
model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
  @@schema("public")
}

// =============================================================================
// Room Management Schema (room schema)
// Related Requirements: REQ-FR-010~015
// =============================================================================

/// Building entity for hospital infrastructure
model Building {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique @db.VarChar(20)
  name      String   @db.VarChar(100)
  address   String?  @db.Text
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  floors Floor[]

  @@map("buildings")
  @@schema("room")
}

/// Floor entity within buildings
model Floor {
  id          String   @id @default(uuid()) @db.Uuid
  buildingId  String   @map("building_id") @db.Uuid
  floorNumber Int      @map("floor_number")
  name        String   @db.VarChar(100)
  department  String?  @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms    Room[]

  @@unique([buildingId, floorNumber])
  @@index([buildingId])
  @@map("floors")
  @@schema("room")
}

/// Room type enumeration
enum RoomType {
  WARD
  ICU
  ISOLATION
  VIP
  EMERGENCY

  @@schema("room")
}

/// Room entity for patient accommodation
model Room {
  id         String   @id @default(uuid()) @db.Uuid
  floorId    String   @map("floor_id") @db.Uuid
  roomNumber String   @map("room_number") @db.VarChar(20)
  name       String?  @db.VarChar(100)
  roomType   RoomType @map("room_type")
  bedCount   Int      @default(1) @map("bed_count")
  isActive   Boolean  @default(true) @map("is_active")
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  floor Floor @relation(fields: [floorId], references: [id], onDelete: Cascade)
  beds  Bed[]

  @@unique([floorId, roomNumber])
  @@index([floorId])
  @@map("rooms")
  @@schema("room")
}

/// Bed status enumeration
enum BedStatus {
  EMPTY
  OCCUPIED
  RESERVED
  MAINTENANCE

  @@schema("room")
}

/// Bed entity for individual patient beds
model Bed {
  id                 String    @id @default(uuid()) @db.Uuid
  roomId             String    @map("room_id") @db.Uuid
  bedNumber          String    @map("bed_number") @db.VarChar(10)
  status             BedStatus @default(EMPTY)
  currentAdmissionId String?   @map("current_admission_id") @db.Uuid
  notes              String?   @db.Text
  isActive           Boolean   @default(true) @map("is_active")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, bedNumber])
  @@index([roomId])
  @@index([status])
  @@map("beds")
  @@schema("room")
}

// =============================================================================
// Patient Management Schema (patient schema)
// Related Requirements: REQ-FR-001~004
// =============================================================================

/// Gender enumeration
enum Gender {
  MALE
  FEMALE
  OTHER

  @@schema("patient")
}

/// Patient entity for patient management
model Patient {
  id                       String    @id @default(uuid()) @db.Uuid
  patientNumber            String    @unique @map("patient_number") @db.VarChar(20)
  name                     String    @db.VarChar(100)
  birthDate                DateTime  @map("birth_date") @db.Date
  gender                   Gender
  bloodType                String?   @map("blood_type") @db.VarChar(10)
  phone                    String?   @db.VarChar(20)
  address                  String?   @db.Text
  emergencyContactName     String?   @map("emergency_contact_name") @db.VarChar(100)
  emergencyContactPhone    String?   @map("emergency_contact_phone") @db.VarChar(20)
  emergencyContactRelation String?   @map("emergency_contact_relation") @db.VarChar(50)
  legacyPatientId          String?   @map("legacy_patient_id") @db.VarChar(50)
  createdAt                DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt                DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  detail  PatientDetail?
  history PatientHistory[]

  @@index([patientNumber])
  @@index([name])
  @@index([legacyPatientId])
  @@index([deletedAt])
  @@map("patients")
  @@schema("patient")
}

/// PatientDetail entity for sensitive patient information
model PatientDetail {
  id                       String   @id @default(uuid()) @db.Uuid
  patientId                String   @unique @map("patient_id") @db.Uuid
  ssnEncrypted             Bytes?   @map("ssn_encrypted")
  medicalHistoryEncrypted  Bytes?   @map("medical_history_encrypted")
  allergies                String?  @db.Text
  insuranceType            String?  @map("insurance_type") @db.VarChar(50)
  insuranceNumberEncrypted Bytes?   @map("insurance_number_encrypted")
  insuranceCompany         String?  @map("insurance_company") @db.VarChar(100)
  notes                    String?  @db.Text
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_details")
  @@schema("patient")
}

/// Sequence for patient number generation
model PatientSequence {
  id        Int      @id @default(autoincrement())
  year      Int      @unique
  lastValue Int      @default(0) @map("last_value")
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@map("patient_sequences")
  @@schema("patient")
}

/// PatientHistory entity for audit trail
model PatientHistory {
  id         String   @id @default(uuid()) @db.Uuid
  patientId  String   @map("patient_id") @db.Uuid
  changedBy  String   @map("changed_by") @db.Uuid
  changedAt  DateTime @default(now()) @map("changed_at") @db.Timestamptz
  changeType String   @map("change_type") @db.VarChar(20)
  fieldName  String?  @map("field_name") @db.VarChar(100)
  oldValue   String?  @map("old_value") @db.Text
  newValue   String?  @map("new_value") @db.Text

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([changedAt(sort: Desc)])
  @@index([patientId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("patient_history")
  @@schema("patient")
}

// =============================================================================
// Admission Management Schema (admission schema)
// Related Requirements: REQ-FR-020~025
// =============================================================================

/// Admission type enumeration
enum AdmissionType {
  SCHEDULED
  EMERGENCY
  TRANSFER_IN

  @@schema("admission")
}

/// Admission status enumeration
enum AdmissionStatus {
  ACTIVE
  DISCHARGED
  TRANSFERRED

  @@schema("admission")
}

/// Discharge type enumeration
enum DischargeType {
  NORMAL
  AMA
  TRANSFER_OUT
  DEATH
  OTHER

  @@schema("admission")
}

/// Admission entity for patient admission management
model Admission {
  id                    String          @id @default(uuid()) @db.Uuid
  patientId             String          @map("patient_id") @db.Uuid
  bedId                 String          @map("bed_id") @db.Uuid
  admissionNumber       String          @unique @map("admission_number") @db.VarChar(20)
  admissionDate         DateTime        @map("admission_date") @db.Date
  admissionTime         String          @map("admission_time") @db.VarChar(10)
  admissionType         AdmissionType   @map("admission_type")
  diagnosis             String?         @db.Text
  chiefComplaint        String?         @map("chief_complaint") @db.Text
  attendingDoctorId     String          @map("attending_doctor_id") @db.Uuid
  primaryNurseId        String?         @map("primary_nurse_id") @db.Uuid
  status                AdmissionStatus @default(ACTIVE)
  expectedDischargeDate DateTime?       @map("expected_discharge_date") @db.Date
  notes                 String?         @db.Text
  createdAt             DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime        @updatedAt @map("updated_at") @db.Timestamptz
  createdBy             String          @map("created_by") @db.Uuid

  // Relations
  transfers     Transfer[]
  discharge     Discharge?
  vitalSigns    VitalSign[]
  intakeOutputs IntakeOutput[]
  medications   Medication[]
  nursingNotes  NursingNote[]
  dailyReports  DailyReport[]

  @@index([patientId])
  @@index([bedId])
  @@index([status])
  @@index([attendingDoctorId])
  @@index([admissionDate])
  @@index([patientId, status])
  @@map("admissions")
  @@schema("admission")
}

/// Transfer entity for patient bed transfers
model Transfer {
  id            String   @id @default(uuid()) @db.Uuid
  admissionId   String   @map("admission_id") @db.Uuid
  fromBedId     String   @map("from_bed_id") @db.Uuid
  toBedId       String   @map("to_bed_id") @db.Uuid
  transferDate  DateTime @map("transfer_date") @db.Date
  transferTime  String   @map("transfer_time") @db.VarChar(10)
  reason        String   @db.VarChar(255)
  notes         String?  @db.Text
  transferredBy String   @map("transferred_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  admission Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@index([admissionId])
  @@index([fromBedId])
  @@index([toBedId])
  @@index([transferDate])
  @@map("transfers")
  @@schema("admission")
}

/// Discharge entity for patient discharge records
model Discharge {
  id                   String        @id @default(uuid()) @db.Uuid
  admissionId          String        @unique @map("admission_id") @db.Uuid
  dischargeDate        DateTime      @map("discharge_date") @db.Date
  dischargeTime        String        @map("discharge_time") @db.VarChar(10)
  dischargeType        DischargeType @map("discharge_type")
  dischargeDiagnosis   String?       @map("discharge_diagnosis") @db.Text
  dischargeSummary     String?       @map("discharge_summary") @db.Text
  followUpInstructions String?       @map("follow_up_instructions") @db.Text
  followUpDate         DateTime?     @map("follow_up_date") @db.Date
  dischargedBy         String        @map("discharged_by") @db.Uuid
  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  admission Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@index([dischargeDate])
  @@map("discharges")
  @@schema("admission")
}

/// Sequence for admission number generation
model AdmissionSequence {
  id        Int      @id @default(autoincrement())
  year      Int      @unique
  lastValue Int      @default(0) @map("last_value")
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@map("admission_sequences")
  @@schema("admission")
}

// =============================================================================
// Report Management Schema (report schema)
// Related Requirements: REQ-FR-030~045
// SDS Reference: Section 4.5 (Report Module), Section 5.1
// =============================================================================

/// Consciousness level enumeration (AVPU scale)
enum Consciousness {
  ALERT
  VERBAL
  PAIN
  UNRESPONSIVE

  @@schema("report")
}

/// Medication administration status enumeration
enum MedicationStatus {
  SCHEDULED
  ADMINISTERED
  HELD
  REFUSED
  MISSED

  @@schema("report")
}

/// Medication route enumeration
enum MedicationRoute {
  PO // Oral
  IV // Intravenous
  IM // Intramuscular
  SC // Subcutaneous
  SL // Sublingual
  TOP // Topical
  INH // Inhalation
  PR // Per rectum
  OTHER

  @@schema("report")
}

/// Nursing note type enumeration
enum NoteType {
  ASSESSMENT
  PROGRESS
  PROCEDURE
  INCIDENT
  HANDOFF

  @@schema("report")
}

/// Patient status enumeration for daily reports
enum PatientStatus {
  STABLE
  IMPROVING
  DECLINING
  CRITICAL

  @@schema("report")
}

/// VitalSign entity for patient vital sign records
model VitalSign {
  id               String         @id @default(uuid()) @db.Uuid
  admissionId      String         @map("admission_id") @db.Uuid
  temperature      Decimal?       @db.Decimal(4, 1)
  systolicBp       Int?           @map("systolic_bp")
  diastolicBp      Int?           @map("diastolic_bp")
  pulseRate        Int?           @map("pulse_rate")
  respiratoryRate  Int?           @map("respiratory_rate")
  oxygenSaturation Int?           @map("oxygen_saturation")
  bloodGlucose     Int?           @map("blood_glucose")
  painScore        Int?           @map("pain_score")
  consciousness    Consciousness?
  measuredAt       DateTime       @map("measured_at") @db.Timestamptz
  measuredBy       String         @map("measured_by") @db.Uuid
  notes            String?        @db.Text
  hasAlert         Boolean        @default(false) @map("has_alert")
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  admission Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@index([admissionId, measuredAt(sort: Desc)])
  @@index([hasAlert])
  @@index([measuredBy])
  @@map("vital_signs")
  @@schema("report")
}

/// IntakeOutput entity for patient intake/output tracking
model IntakeOutput {
  id             String   @id @default(uuid()) @db.Uuid
  admissionId    String   @map("admission_id") @db.Uuid
  recordDate     DateTime @map("record_date") @db.Date
  recordTime     DateTime @map("record_time") @db.Time
  // Intake
  oralIntake     Int      @default(0) @map("oral_intake")
  ivIntake       Int      @default(0) @map("iv_intake")
  tubeFeeding    Int      @default(0) @map("tube_feeding")
  otherIntake    Int      @default(0) @map("other_intake")
  // Output
  urineOutput    Int      @default(0) @map("urine_output")
  stoolOutput    Int      @default(0) @map("stool_output")
  vomitOutput    Int      @default(0) @map("vomit_output")
  drainageOutput Int      @default(0) @map("drainage_output")
  otherOutput    Int      @default(0) @map("other_output")
  // Metadata
  recordedBy     String   @map("recorded_by") @db.Uuid
  notes          String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  admission Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@index([admissionId, recordDate])
  @@index([recordedBy])
  @@map("intake_outputs")
  @@schema("report")
}

/// Medication entity for medication administration tracking
model Medication {
  id             String           @id @default(uuid()) @db.Uuid
  admissionId    String           @map("admission_id") @db.Uuid
  medicationName String           @map("medication_name") @db.VarChar(255)
  dosage         String           @db.VarChar(100)
  route          MedicationRoute
  frequency      String?          @db.VarChar(100)
  scheduledTime  DateTime?        @map("scheduled_time") @db.Time
  administeredAt DateTime?        @map("administered_at") @db.Timestamptz
  administeredBy String?          @map("administered_by") @db.Uuid
  status         MedicationStatus
  holdReason     String?          @map("hold_reason") @db.Text
  notes          String?          @db.Text
  createdAt      DateTime         @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  admission Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@index([admissionId, administeredAt])
  @@index([admissionId, status])
  @@index([administeredBy])
  @@map("medications")
  @@schema("report")
}

/// NursingNote entity for nursing documentation (SOAP format)
model NursingNote {
  id            String   @id @default(uuid()) @db.Uuid
  admissionId   String   @map("admission_id") @db.Uuid
  noteType      NoteType @map("note_type")
  // SOAP Format
  subjective    String?  @db.Text
  objective     String?  @db.Text
  assessment    String?  @db.Text
  plan          String?  @db.Text
  // Metadata
  recordedAt    DateTime @map("recorded_at") @db.Timestamptz
  recordedBy    String   @map("recorded_by") @db.Uuid
  isSignificant Boolean  @default(false) @map("is_significant")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  admission Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@index([admissionId, recordedAt(sort: Desc)])
  @@index([admissionId, noteType])
  @@index([recordedBy])
  @@index([isSignificant])
  @@map("nursing_notes")
  @@schema("report")
}

/// DailyReport entity for aggregated daily patient reports
model DailyReport {
  id               String         @id @default(uuid()) @db.Uuid
  admissionId      String         @map("admission_id") @db.Uuid
  reportDate       DateTime       @map("report_date") @db.Date
  // Vital Signs Summary
  vitalsSummary    Json?          @map("vitals_summary") @db.JsonB
  // I/O Summary
  totalIntake      Int?           @map("total_intake")
  totalOutput      Int?           @map("total_output")
  ioBalance        Int?           @map("io_balance")
  // Medication Summary
  medicationsGiven Int?           @map("medications_given")
  medicationsHeld  Int?           @map("medications_held")
  // Overall
  patientStatus    PatientStatus? @map("patient_status")
  summary          String?        @db.Text
  alerts           Json?          @db.JsonB
  generatedAt      DateTime       @default(now()) @map("generated_at") @db.Timestamptz
  generatedBy      String?        @map("generated_by") @db.Uuid

  // Relations
  admission Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@unique([admissionId, reportDate])
  @@index([admissionId, reportDate(sort: Desc)])
  @@index([reportDate])
  @@map("daily_reports")
  @@schema("report")
}

// =============================================================================
// Audit Schema (audit schema)
// Related Requirements: REQ-NFR-030~033
// SDS Reference: Section 4.7.2 (Audit Log Service), Section 7.4 (Audit Logging Design)
// =============================================================================

/// Device type enumeration for login history
enum DeviceType {
  PC
  TABLET
  MOBILE

  @@schema("audit")
}

/// Audit action enumeration
enum AuditAction {
  READ
  CREATE
  UPDATE
  DELETE

  @@schema("audit")
}

/// LoginHistory entity for tracking user login attempts
model LoginHistory {
  id            String      @id @default(uuid()) @db.Uuid
  userId        String?     @map("user_id") @db.Uuid
  username      String      @db.VarChar(50)
  ipAddress     String      @map("ip_address") @db.VarChar(45)
  userAgent     String?     @map("user_agent") @db.Text
  deviceType    DeviceType? @map("device_type")
  browser       String?     @db.VarChar(50)
  os            String?     @db.VarChar(50)
  loginAt       DateTime    @default(now()) @map("login_at") @db.Timestamptz
  logoutAt      DateTime?   @map("logout_at") @db.Timestamptz
  sessionId     String?     @map("session_id") @db.VarChar(100)
  success       Boolean
  failureReason String?     @map("failure_reason") @db.VarChar(100)
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId, loginAt(sort: Desc)])
  @@index([ipAddress, loginAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("login_history")
  @@schema("audit")
}

/// AccessLog entity for tracking patient information access
model AccessLog {
  id             String      @id @default(uuid()) @db.Uuid
  userId         String      @map("user_id") @db.Uuid
  username       String      @db.VarChar(50)
  userRole       String?     @map("user_role") @db.VarChar(50)
  ipAddress      String      @map("ip_address") @db.VarChar(45)
  resourceType   String      @map("resource_type") @db.VarChar(50)
  resourceId     String      @map("resource_id") @db.Uuid
  action         AuditAction
  requestPath    String?     @map("request_path") @db.VarChar(255)
  requestMethod  String?     @map("request_method") @db.VarChar(10)
  patientId      String?     @map("patient_id") @db.Uuid
  accessedFields String[]    @map("accessed_fields")
  success        Boolean     @default(true)
  errorCode      String?     @map("error_code") @db.VarChar(50)
  errorMessage   String?     @map("error_message") @db.Text
  createdAt      DateTime    @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId, createdAt(sort: Desc)])
  @@index([patientId, createdAt(sort: Desc)])
  @@index([resourceType, resourceId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("access_logs")
  @@schema("audit")
}

/// ChangeLog entity for tracking data changes
model ChangeLog {
  id            String      @id @default(uuid()) @db.Uuid
  userId        String      @map("user_id") @db.Uuid
  username      String      @db.VarChar(50)
  ipAddress     String?     @map("ip_address") @db.VarChar(45)
  tableSchema   String      @map("table_schema") @db.VarChar(50)
  tableName     String      @map("table_name") @db.VarChar(100)
  recordId      String      @map("record_id") @db.Uuid
  action        AuditAction
  oldValues     Json?       @map("old_values") @db.JsonB
  newValues     Json?       @map("new_values") @db.JsonB
  changedFields String[]    @map("changed_fields")
  changeReason  String?     @map("change_reason") @db.Text
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz

  @@index([userId, createdAt(sort: Desc)])
  @@index([tableSchema, tableName, createdAt(sort: Desc)])
  @@index([recordId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("change_logs")
  @@schema("audit")
}
